#!/usr/bin/env php
<?php
/**
 * WarnParser für neuthardwetter.de by Jens Dutzi - WetterBot.php
 *
 * @package    blog404de\WetterWarnung
 * @author     Jens Dutzi <jens.dutzi@tf-network.de>
 * @copyright  Copyright (c) 2012-2018 Jens Dutzi (http://www.neuthardwetter.de)
 * @license    https://github.com/Blog404DE/WetterwarnungDownloader/blob/master/LICENSE.md
 * @version    2.7.0-dev
 * @link       https://github.com/Blog404DE/WetterwarnungDownloader
 */

// Root-Verzeichnis festlegen
try {
    $unwetterConfig = [];
    if (is_readable(dirname(__FILE__) . "/config.local.php")) {
        require_once dirname(__FILE__) . "/config.local.php";
    } else {
        throw new Exception(
            "Konfigurationsdatei 'config.local.php' existiert nicht. Zur Konfiguration lesen Sie README.md"
        );
    }

    // Autoloader initialisieren
    require_once  dirname(__FILE__) . "/botLib/autoload.php";

    /*
     * Error-Logger instanzieren
     */
    $logger = new \blog404de\WetterWarnung\ErrorLogging();

    // Fehler-Handling aktivieren
    if (!empty($optFehlerMail)) {
        $logger->setLogToMailSettings($optFehlerMail);
    }
    if (!empty($optFehlerLogfile)) {
        $logger->setLogToFileSettings($optFehlerLogfile);
    }
    if (defined("LOGWITHTRACE")) {
        $logger->setWithTrace(true);
    }

    /*
      * Script-Header ausgeben
      */

    echo(PHP_EOL);
    $header  = "Starte Warnlage-Update " . date("d.m.Y H:i:s") . ":" . PHP_EOL;
    $header .= str_repeat("=", strlen(trim($header))) . PHP_EOL;
    echo $header;

    // Prüfe Konfigurationsdatei auf Vollständigkeit
    $configKeysNeeded = ["WarnCells", "localJsonWarnfile", "localFolder", "ftpmode"];
    foreach ($configKeysNeeded as $configKey) {
        if (array_key_exists($configKey, $unwetterConfig)) {
        } else {
            throw new Exception(
                "Die Konfigurationsdatei config.local.php ist unvollständig ('" . $configKey . "' ist nicht vorhanden)"
            );
        }
    }

    /*
     *  WarnParser instanzieren
     */
    $warnBot = new \blog404de\WetterWarnung\WetterWarnung();

    // Konfiguriere Bot
    $warnBot->setLocalFolder($unwetterConfig["localFolder"]);
    $warnBot->setLocalJsonFile($unwetterConfig["localJsonWarnfile"]);

    if ($unwetterConfig["Archive"]) {
        // MySQL Zugangsdaten setzen für Archiv-Funktion
        $warnBot->archive->setConfig($unwetterConfig["MySQL"]);
    }

    if (!array_key_exists("passiv", $unwetterConfig["ftpmode"])) {
        // Passiv/Aktive Verbindung zum FTP Server ist nicht konfiguriert -> daher aktive Verbindung
        $unwetterConfig["ftpmode"]["passiv"] = false;
    }

    // Neue Wetterwarnungen vom DWD FTP Server holen
    if (!defined("BLOCKFTP")) {
        $warnBot->network->setFtpPassiv($unwetterConfig["ftpmode"]["passiv"]);
        $warnBot->network->connectToFTP("opendata.dwd.de", "Anonymous", "Anonymous");
        $warnBot->network->updateFromFTP();
        $warnBot->network->disconnectFromFTP();
        $warnBot->network->cleanLocalDownloadFolder();
    }

    // Wetterwarnungen vorbereiten
    $warnBot->prepareWetterWarnungen();

    // Wetterwarnungen parsen
    if (is_array($unwetterConfig["WarnCells"]) && count($unwetterConfig["WarnCells"]) > 0) {
        foreach ($unwetterConfig["WarnCells"] as $warnCell) {
            if (array_key_exists("warnCellId", $warnCell) && array_key_exists("stateShort", $warnCell)) {
                $warnBot->parseWetterWarnungen($warnCell["warnCellId"], $warnCell["stateShort"]);
            } else {
                // WarnCell-Konfiguration fehlen die benötigten Angaben
                throw new Exception(
                    "Der Konfigurationsparameterfür die WarnCellId-Array beinhaltet nicht die "  .
                    "notwendigen Informationen (siehe README.md)"
                );
            }
        }
    } else {
        // Variablen-Typ ist falsch
        throw new Exception(
            "Der Konfigurationsparameter für die WarnCellId ist kein Array oder Array beinhaltet kein Eintrag"
        );
    }

    // Speichere Wetterwarnungen
    $fileupdated = $warnBot->saveToFile();

    // Cache aufräumen
    $warnBot->cleanLocalCache();
} catch (Exception $e) {
    // Fehler-Handling
    $logger->logError($e, $warnBot->getTmpFolder());
    exit(-1);
}
?>

